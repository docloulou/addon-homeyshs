name: Auto-bump Homey SHS add-on

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (no commit / tag / release)"
        required: true
        default: "true"
  schedule:
    # Runs once a day at 03:00 UTC
    - cron: '0 3 * * *'

jobs:
  bump-from-ghcr:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    # For scheduled runs, DRY_RUN defaults to "false"
    # For manual runs, uses the provided input
    env:
      DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}

    steps:
      - name: Checkout addon repo
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo apt-get update -y
          sudo wget -qO /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Get latest stable SHS tag from GitHub HTML
        id: ghcr
        run: |
          # Fetch the public HTML page that lists tagged container versions
          HTML=$(curl -s 'https://github.com/orgs/athombv/packages/container/homey-shs/versions?filters%5Bversion_type%5D=tagged')

          # Extract texts that look like pure semver tags from links:
          #   >12.11.1<  =>  12.11.1
          TAGS=$(printf '%s\n' "$HTML" \
            | grep -oE '>[0-9]+\.[0-9]+\.[0-9]+<' \
            | tr -d '><' \
            | sort -u)

          if [ -z "$TAGS" ]; then
            echo "No semver-looking tags (x.y.z) found in HTML."
            echo "latest_tag=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Stable semver tags found:"
          printf '%s\n' $TAGS

          # Pick the highest semantic version (reverse version sort)
          LATEST_TAG=$(printf '%s\n' $TAGS | sort -Vr | head -n1)

          echo "Latest stable SHS tag: $LATEST_TAG"
          echo "latest_tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"

      - name: Read current add-on version
        id: addon
        run: |
          CURRENT_VERSION=$(yq '.version' homey-shs/config.yaml)
          echo "Current add-on version: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"

      - name: Decide if bump is needed
        id: decide
        run: |
          LATEST="${{ steps.ghcr.outputs.latest_tag }}"
          CURRENT="${{ steps.addon.outputs.current_version }}"

          if [ -z "$LATEST" ]; then
            echo "No latest tag resolved, skipping."
            echo "should_bump=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$LATEST" = "$CURRENT" ]; then
            echo "Add-on already at latest SHS version ($CURRENT)."
            echo "should_bump=false" >> "$GITHUB_OUTPUT"
          else
            echo "Add-on is outdated: $CURRENT -> $LATEST"
            echo "should_bump=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Show what WOULD change
        if: steps.decide.outputs.should_bump == 'true'
        run: |
          echo "DRY_RUN = '${DRY_RUN}'"
          echo "Would bump add-on version from ${{ steps.addon.outputs.current_version }} to ${{ steps.ghcr.outputs.latest_tag }}"
          echo "Would update build.yaml build_from images to ghcr.io/athombv/homey-shs:${{ steps.ghcr.outputs.latest_tag }}"
          echo "Would prepend a changelog entry for version ${{ steps.ghcr.outputs.latest_tag }}"
          echo "Would commit, tag and create a GitHub Release"

      - name: Apply changes to config.yaml and build.yaml
        if: steps.decide.outputs.should_bump == 'true' && env.DRY_RUN == 'false'
        run: |
          NEW_VERSION="${{ steps.ghcr.outputs.latest_tag }}"

          echo "Updating config.yaml version to ${NEW_VERSION}..."
          yq -i ".version = \"${NEW_VERSION}\"" homey-shs/config.yaml

          if [ -f homey-shs/build.yaml ]; then
            echo "Updating build.yaml base images to SHS ${NEW_VERSION}..."
            yq -i ".build_from.amd64 = \"ghcr.io/athombv/homey-shs:${NEW_VERSION}\"" homey-shs/build.yaml
            yq -i ".build_from.aarch64 = \"ghcr.io/athombv/homey-shs:${NEW_VERSION}\"" homey-shs/build.yaml

            echo "New build.yaml:"
            cat homey-shs/build.yaml
          else
            echo "WARNING: homey-shs/build.yaml not found, skipping build_from update."
          fi

          echo "New config.yaml:"
          yq '.' homey-shs/config.yaml

      - name: Update CHANGELOG.md
        if: steps.decide.outputs.should_bump == 'true' && env.DRY_RUN == 'false'
        run: |
          NEW_VERSION="${{ steps.ghcr.outputs.latest_tag }}"
          TODAY=$(date -u +%Y-%m-%d)
          FILE="homey-shs/CHANGELOG.md"

          echo "Updating changelog ${FILE} for version ${NEW_VERSION}..."

          # Ensure file ends with a newline
          sed -i -e '$a\' "$FILE"

          # Find the first version heading line (starts with '## [')
          VERSION_LINE=$(grep -n '^## \[' "$FILE" | head -n1 | cut -d: -f1 || true)

          if [ -z "$VERSION_LINE" ]; then
            # No existing versions, treat whole file as header
            HEADER_END=$(wc -l < "$FILE")
          else
            # Header is everything before the first version line
            HEADER_END=$((VERSION_LINE - 1))
          fi

          tmpfile=$(mktemp)
          {
            # Header block (everything before the first '## [' line)
            if [ "$HEADER_END" > 0 ] 2>/dev/null; then
              head -n "$HEADER_END" "$FILE"
            fi
            echo ""
            # New entry for the latest SHS version
            echo "## [${NEW_VERSION}] - ${TODAY}"
            echo "### Changed"
            echo "- Updated Homey Self-Hosted Server base image to version ${NEW_VERSION}"
            echo "- You can check out the Homey Self-Hosted Server changelog here: https://homey.app/en-us/wiki/homey-shs-changelog/"
            echo ""
            # Existing entries (from the first version heading onwards)
            if [ -n "$VERSION_LINE" ]; then
              tail -n +"$VERSION_LINE" "$FILE"
            fi
          } > "$tmpfile"

          mv "$tmpfile" "$FILE"

          echo "New top of CHANGELOG.md:"
          head -n 20 "$FILE"

      - name: Extract release notes from CHANGELOG
        if: steps.decide.outputs.should_bump == 'true' && env.DRY_RUN == 'false'
        id: notes
        run: |
          NEW_VERSION="${{ steps.ghcr.outputs.latest_tag }}"
          FILE="homey-shs/CHANGELOG.md"

          # Extract the section for this version from the changelog
          # Includes the "## [x.y.z]" header and its contents,
          # stops when the next "## [" header is encountered.
          awk -v ver="$NEW_VERSION" '
            $0 ~ "^## \\[" ver "\\]" {flag=1}
            flag && $0 ~ "^## \\[" && $0 !~ "^## \\[" ver "\\]" {exit}
            flag {print}
          ' "$FILE" > RELEASE_NOTES.txt

          echo "Release notes generated:"
          cat RELEASE_NOTES.txt

      - name: Commit and push changes
        if: steps.decide.outputs.should_bump == 'true' && env.DRY_RUN == 'false'
        run: |
          NEW_VERSION="${{ steps.ghcr.outputs.latest_tag }}"

          git config user.name "homey-shs-bot"
          git config user.email "ci@homeyshs.local"

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -am "chore: bump Homey SHS add-on to ${NEW_VERSION}"
          git push

      - name: Create and push git tag
        if: steps.decide.outputs.should_bump == 'true' && env.DRY_RUN == 'false'
        run: |
          NEW_VERSION="${{ steps.ghcr.outputs.latest_tag }}"

          # Only create tag if it doesn't already exist
          if git rev-parse "refs/tags/${NEW_VERSION}" >/dev/null 2>&1; then
            echo "Tag ${NEW_VERSION} already exists, not creating a new one."
            exit 0
          fi

          echo "Creating git tag ${NEW_VERSION}..."
          git tag "${NEW_VERSION}"
          git push origin "${NEW_VERSION}"

      - name: Create GitHub Release
        if: steps.decide.outputs.should_bump == 'true' && env.DRY_RUN == 'false'
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.ghcr.outputs.latest_tag }}
          release_name: Homey SHS add-on ${{ steps.ghcr.outputs.latest_tag }}
          body_path: RELEASE_NOTES.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
